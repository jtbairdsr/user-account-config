#!/bin/bash
usage () {
	echo "usage: kb <board>            => alias for 'kb show'"
	echo "   or: kb add <task details> => adds a task to the default boards backlog"
	echo "   or: kb move task          => moves a taks to the specified stage.
                                - If that stage is doing it starts the task
                                - If that stage done it completes the task
                                - Otherwise it stops the task"
	echo "   or: kb start task         => alias for 'kb move <task> doing'"
	echo "   or: kb show <board>       => shows the specified board"
	echo "   or: kb <options>          => see options for details"
	echo
	echo "   options:"
	echo "   -h		show this help"
}

while getopts ":h" opt; do
	case ${opt} in
		h)
			usage
			exit
			;;
		\?)
			echo "invalid option -$OPTARG" >&2
			exit 1
			;;
	esac
done

KB_DEFAULT_BOARD=${KB_DEFAULT_BOARD:-work}
KB_DEFAULT_STAGE=${KB_DEFAULT_STAGE:-backlog}

subcommand=$1
shift

case $subcommand in
	add)
		while getopts ":b:s:" opt; do
			case ${opt} in
				b)
					board=$OPTARG
					shift $((OPTIND-1))
					;;
				s)
					stage=$OPTARG
					shift $((OPTIND-1))
					;;
				\?)
					echo "invalid option -$OPTARG" >&2
					exit 1
					;;
			esac
		done

		task add "board:${board:-$KB_DEFAULT_BOARD}" "stage:${stage:-$KB_DEFAULT_STAGE}" "$@"
		"$0" "$board"
		;;
	move)
		task=$1
		shift
		stage=$1

		# TODO: decide if I want to make the task the last parameter passed so that we don't have to quote queries at
		# the cli

		# we need to not double quote the tasks so that it can split and we can pass queries to tw and move more than one
		# task at a time...
		# shellcheck disable=SC2086
		case $stage in
			'icebox' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'Icebox'
				task rc.bulk=0 $task stop;;
			'backlog' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'To Do'
				task rc.bulk=0 $task stop;;
			'next' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'Next'
				task rc.bulk=0 $task stop;;
			'doing' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'Doing'
				task rc.bulk=0 $task start;;
			'deploy' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'Deploy'
				task rc.bulk=0 $task stop;;
			'done' )
				task rc.bulk=0 $task modify stage:"$stage" intheamtrellolistname:'Done'
				task rc.bulk=0 $task 'done';;
			* )
				echo "$stage is not a recognized stage..."
				exit 1;;
		esac

		/Users/jonathan/bin/tsync

		"$0"
		;;
	move-board)
		task=$1
		shift
		board=$1

		# we need to not double quote the tasks so that it can split and we can pass queries to tw and move more than one
		# task at a time...
		# shellcheck disable=SC2086
		task rc.bulk=0 $task modify board:"$board"

		/Users/jonathan/bin/tsync

		"$0"
		;;
	start)
		if [ -z "$1" ]; then
			echo need a task number to start >&2
			exit 1
		else
			"$0" move "$1" doing
		fi
		;;
	show) "$0" "$1" ;;
	''  ) twkb show -b "$KB_DEFAULT_BOARD" ;;
	*   ) twkb show -b "$subcommand" ;;
esac
